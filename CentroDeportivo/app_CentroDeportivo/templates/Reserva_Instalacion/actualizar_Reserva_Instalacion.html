{% extends 'base.html' %}

{% block title %}Actualizar Reserva de Instalación{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="form-container">
            <h2 class="mb-4" style="color: #f39c12;">
                <i class="bi bi-calendar-check-fill"></i> Actualizar Reserva
            </h2>
            
            <form method="POST" action="{% url 'actualizar_reserva' reserva.id_reserva %}">
                {% csrf_token %}
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Instalación:</label>
                            <select class="form-control" name="instalacion" id="id_instalacion" required>
                                {% for instalacion_item in instalaciones %}
                                    <option value="{{ instalacion_item.id_instalacion }}" 
                                        {% if instalacion_item.id_instalacion == reserva.instalacion.id_instalacion %}selected{% endif %}>
                                        {{ instalacion_item.nombre_instalacion }} ({{ instalacion_item.tipo_instalacion }})
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Deportista:</label>
                            <select class="form-control" name="deportista" id="id_deportista" required>
                                {% for deportista_item in deportistas %}
                                    <option value="{{ deportista_item.id_deportista }}" 
                                        {% if deportista_item.id_deportista == reserva.deportista.id_deportista %}selected{% endif %}>
                                        {{ deportista_item.nombre }} {{ deportista_item.apellido }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Info boxes -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div id="info_instalacion" class="p-3 border rounded bg-light" style="min-height: 140px;">
                            <h6><i class="bi bi-building"></i> Info de la Instalación</h6>
                            <p class="text-muted small">Seleccione una instalación para ver sus datos.</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div id="info_deportista" class="p-3 border rounded bg-light" style="min-height: 140px;">
                            <h6><i class="bi bi-person-fill"></i> Info del Deportista</h6>
                            <p class="text-muted small">Seleccione un deportista para ver sus datos.</p>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Fecha de Reserva:</label>
                            <input type="date" class="form-control" name="fecha_reserva" value="{{ reserva.fecha_reserva|date:'Y-m-d' }}" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Hora de Inicio:</label>
                            <input type="time" class="form-control" name="hora_inicio" value="{{ reserva.hora_inicio|time:'H:i' }}" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Hora de Fin:</label>
                            <input type="time" class="form-control" name="hora_fin" value="{{ reserva.hora_fin|time:'H:i' }}" required>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Motivo de la Reserva:</label>
                    <input type="text" class="form-control" name="motivo_reserva" value="{{ reserva.motivo_reserva }}" required>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Duración (Horas):</label>
                            <input type="number" step="0.5" class="form-control" name="duracion_horas" min="0.5" value="{{ reserva.duracion_horas }}" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Monto Pagado:</label>
                            <input type="number" step="0.01" class="form-control" name="monto_pagado" min="0" value="{{ reserva.monto_pagado|stringformat:".2f" }}" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Estado:</label>
                            <select class="form-control" name="estado_reserva" required>
                                <option value="Confirmada" {% if reserva.estado_reserva == 'Confirmada' %}selected{% endif %}>Confirmada</option>
                                <option value="Pendiente" {% if reserva.estado_reserva == 'Pendiente' %}selected{% endif %}>Pendiente</option>
                                <option value="Cancelada" {% if reserva.estado_reserva == 'Cancelada' %}selected{% endif %}>Cancelada</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                    <a href="{% url 'ver_reservas' %}" class="btn btn-secondary me-md-2">
                        <i class="bi bi-arrow-left"></i> Cancelar
                    </a>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-check-circle"></i> Actualizar Reserva
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{{ instalaciones_data|json_script:"instalaciones-data" }}
{{ deportistas_data|json_script:"deportistas-data" }}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const deportistasData = JSON.parse(document.getElementById('deportistas-data').textContent || '[]');
        const instalacionesData = JSON.parse(document.getElementById('instalaciones-data').textContent || '[]');
        
        const deportistaSelect = document.getElementById('id_deportista');
        const instalacionSelect = document.getElementById('id_instalacion');
        
        const infoDeportistaDiv = document.getElementById('info_deportista');
        const infoInstalacionDiv = document.getElementById('info_instalacion');

        const deportistasMap = new Map(deportistasData.map(d => [String(d.id_deportista), d]));
        const instalacionesMap = new Map(instalacionesData.map(i => [String(i.id_instalacion), i]));

        function updateDeportistaInfo() {
            const selectedId = deportistaSelect.value;
            const deportista = deportistasMap.get(selectedId);
            if (deportista) {
                infoDeportistaDiv.innerHTML = `
                    <h6><i class="bi bi-person-fill"></i> Info del Deportista</h6>
                    <p class="mb-1"><strong>Nombre:</strong> ${deportista.nombre} ${deportista.apellido}</p>
                    <p class="mb-1"><strong>Email:</strong> ${deportista.email || 'No especificado'}</p>
                    <p class="mb-0"><strong>Teléfono:</strong> ${deportista.telefono || 'No especificado'}</p>
                `;
            } else {
                infoDeportistaDiv.innerHTML = `
                    <h6><i class="bi bi-person-fill"></i> Info del Deportista</h6>
                    <p class="text-muted small">Seleccione un deportista para ver sus datos.</p>
                `;
            }
        }

        function updateInstalacionInfo() {
            const selectedId = instalacionSelect.value;
            const instalacion = instalacionesMap.get(selectedId);
            if (instalacion) {
                infoInstalacionDiv.innerHTML = `
                    <h6><i class="bi bi-building"></i> Info de la Instalación</h6>
                    <p class="mb-1"><strong>Tipo:</strong> ${instalacion.tipo_instalacion}</p>
                    <p class="mb-1"><strong>Ubicación:</strong> ${instalacion.ubicacion}</p>
                    <p class="mb-0"><strong>Costo/Hora:</strong> ${instalacion.costo_alquiler_hora}</p>
                `;
            } else {
                infoInstalacionDiv.innerHTML = `
                    <h6><i class="bi bi-building"></i> Info de la Instalación</h6>
                    <p class="text-muted small">Seleccione una instalación para ver sus datos.</p>
                `;
            }
        }

        deportistaSelect.addEventListener('change', updateDeportistaInfo);
        instalacionSelect.addEventListener('change', updateInstalacionInfo);

        // Initialize info boxes on page load
        updateDeportistaInfo();
        updateInstalacionInfo();
    });
</script>
{% endblock %}